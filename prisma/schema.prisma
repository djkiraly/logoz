generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum FulfillmentMethod {
  EMBROIDERY
  SCREEN_PRINT
  DTG
  VINYL
  SUBLIMATION
  LASER
  PROMO
}

model SiteSetting {
  id             Int     @id @default(1)
  siteName       String  @default("Logoz Custom")
  heroHeading    String
  heroCopy       String
  ctaLabel       String
  ctaLink        String
  contactEmail   String  @unique
  contactPhone   String
  address        String
  announcement   String?
  bannerEnabled    Boolean @default(true)
  headerCtaEnabled Boolean @default(true)
  headerCtaLabel   String  @default("Build a design")
  headerCtaLink    String  @default("/design-studio")
  copyrightText    String  @default("Crafted in the cloud.")
  theme          Json?
  gcsConfig      Json?
  faviconUrl     String?
  logoUrl        String?

  // Hero Video Intro Configuration
  heroVideoEnabled  Boolean @default(false)
  heroVideoUrl      String?  // YouTube or other video embed URL
  heroVideoAutoplay Boolean @default(true)
  heroVideoMuted    Boolean @default(true)
  heroVideoDuration Int?     // Duration in seconds (for fade timing)

  // reCAPTCHA Configuration
  recaptchaEnabled   Boolean @default(false)
  recaptchaSiteKey   String?
  recaptchaSecretKey String?
}

model Category {
  id          String     @id @default(cuid())
  slug        String     @unique
  title       String
  description String
  imageUrl    String?
  featured    Boolean    @default(false)
  services    Service[]
  products    Product[]
  suppliers   Supplier[] @relation("SupplierCategories")

  @@index([featured, title])
}

model Supplier {
  id             String           @id @default(cuid())
  name           String           @unique
  logoUrl        String?
  website        String?
  description    String?
  leadTimeDays   Int?
  featured       Boolean          @default(false)
  categories     Category[]       @relation("SupplierCategories")
  products       Product[]
  quoteLineItems QuoteLineItem[]

  @@index([featured, name])
}

model Product {
  id           String              @id @default(cuid())
  sku          String              @unique
  name         String
  description  String
  heroImageUrl String?
  gallery      String[]
  basePrice    Decimal             @db.Money
  cost         Decimal?            @db.Money
  minQuantity  Int                 @default(1)
  category     Category            @relation(fields: [categoryId], references: [id])
  categoryId   String
  supplier     Supplier?           @relation(fields: [supplierId], references: [id])
  supplierId   String?
  fulfillment  FulfillmentMethod[]
  variants     Variant[]
  designs      Design[]
  collections  Collection[]        @relation("CollectionProducts")
  quoteLineItems QuoteLineItem[]
  productViews ProductView[]
  visible      Boolean             @default(false)
  featured     Boolean             @default(false)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([categoryId])
  @@index([supplierId])
  @@index([visible])
  @@index([createdAt(sort: Desc)])
}

model Variant {
  id          String   @id @default(cuid())
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId   String
  color       String
  size        String
  priceAdjust Decimal? @db.Money
  inventory   Int?     @default(0)

  @@unique([productId, color, size])
  @@index([productId])
}

model Design {
  id           String      @id @default(cuid())
  title        String
  description  String?
  previewUrl   String
  sourceFile   String?
  tags         String[]
  products     Product[]
  collection   Collection? @relation(fields: [collectionId], references: [id])
  collectionId String?
  featured     Boolean     @default(false)

  @@index([featured])
  @@index([collectionId])
}

model Collection {
  id          String    @id @default(cuid())
  slug        String    @unique
  name        String
  description String
  heroImage   String?
  products    Product[] @relation("CollectionProducts")
  designs     Design[]
}

model Service {
  id         String              @id @default(cuid())
  slug       String              @unique
  title      String
  summary    String
  body       String
  heroImage  String?
  methods    FulfillmentMethod[]
  ctaLabel   String?
  ctaLink    String?
  categories Category[]
}

model Testimonial {
  id        String  @id @default(cuid())
  author    String  @unique
  title     String?
  company   String?
  quote     String
  rating    Int     @default(5)
  avatarUrl String?

  @@index([rating(sort: Desc)])
}

model Faq {
  id       String  @id @default(cuid())
  question String  @unique
  answer   String
  category String?

  @@index([category])
}

model QuoteRequest {
  id          String            @id @default(cuid())
  contactName String
  company     String?
  email       String
  phone       String?
  dueDate     DateTime?
  quantity    Int
  serviceType FulfillmentMethod
  notes       String?
  productId   String?
  status      QuoteStatus       @default(PENDING)
  attachments String[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([email])
  @@index([status])
  @@index([serviceType])
  @@index([createdAt(sort: Desc)])
}

enum QuoteStatus {
  PENDING
  REVIEWING
  SENT
  ARTWORK_PENDING    // Artwork sent to customer, awaiting approval
  ARTWORK_APPROVED   // Customer approved the artwork
  ARTWORK_DECLINED   // Customer declined the artwork
  APPROVED
  DECLINED
  ARCHIVED
}

// ===========================================
// Admin Quotes (Generated by Staff)
// ===========================================

model Quote {
  id              String          @id @default(cuid())
  quoteNumber     String          @unique

  // Customer reference
  customer        Customer?       @relation(fields: [customerId], references: [id])
  customerId      String?

  // Or manual customer info (for quick quotes without full customer record)
  customerName    String?
  customerEmail   String?
  customerPhone   String?
  customerCompany String?

  // Quote details
  title           String?
  notes           String?
  internalNotes   String?

  // Dates
  validUntil      DateTime?
  requestedDelivery DateTime?

  // Pricing
  subtotal        Decimal         @default(0) @db.Money
  discountValue   Decimal         @default(0)  // User's input value (percentage or fixed amount)
  discount        Decimal         @default(0) @db.Money  // Calculated discount amount
  discountType    DiscountType    @default(FIXED)
  tax             Decimal         @default(0) @db.Money
  taxRate         Decimal         @default(0)
  shipping        Decimal         @default(0) @db.Money
  total           Decimal         @default(0) @db.Money

  // Status
  status          QuoteStatus     @default(PENDING)
  sentAt          DateTime?
  approvedAt      DateTime?
  declinedAt      DateTime?

  // Public access token for customer viewing/approval
  accessToken     String?         @unique

  // Artwork approval workflow
  artworkRequired     Boolean     @default(false)
  artworkUrl          String?     // URL to the artwork file
  artworkFileName     String?     // Original filename for display
  artworkToken        String?     @unique  // Token for public artwork approval page
  artworkSentAt       DateTime?   // When artwork was sent to customer
  artworkApprovedAt   DateTime?   // When customer approved artwork
  artworkDeclinedAt   DateTime?   // When customer declined artwork
  artworkNotes        String?     // Customer's notes on artwork (approval/decline reason)
  artworkVersion      Int         @default(1)  // Track artwork revisions

  // Artwork version history
  artworkVersions     ArtworkVersion[]

  // Line items
  lineItems       QuoteLineItem[]

  // Audit trail
  auditLogs       QuoteAuditLog[]

  // Quote Owner (internal resource responsible for the quote)
  owner           AdminUser?      @relation("QuoteOwner", fields: [ownerId], references: [id])
  ownerId         String?

  // Metadata
  createdBy       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  lastModifiedAt  DateTime        @default(now())

  @@index([customerId])
  @@index([status])
  @@index([quoteNumber])
  @@index([ownerId])
  @@index([createdAt(sort: Desc)])
  @@index([lastModifiedAt(sort: Desc)])
}

// ===========================================
// Artwork Version History
// ===========================================

model ArtworkVersion {
  id              String    @id @default(cuid())
  quote           Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  quoteId         String

  // Version info
  version         Int
  url             String    // URL to the artwork file
  fileName        String    // Original filename

  // Status at time of archival
  status          String    // PENDING, APPROVED, DECLINED
  sentAt          DateTime?
  approvedAt      DateTime?
  declinedAt      DateTime?
  customerNotes   String?   // Customer feedback for this version

  // Who uploaded this version
  uploadedById    String?
  uploadedByName  String?
  uploadedByEmail String?

  createdAt       DateTime  @default(now())

  @@unique([quoteId, version])
  @@index([quoteId])
  @@index([createdAt(sort: Desc)])
}

model QuoteLineItem {
  id              String          @id @default(cuid())
  quote           Quote           @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  quoteId         String

  // Line item type
  itemType        LineItemType    @default(PRODUCT)

  // Product reference (optional)
  product         Product?        @relation(fields: [productId], references: [id])
  productId       String?

  // Vendor/Supplier reference (optional)
  supplier        Supplier?       @relation(fields: [supplierId], references: [id])
  supplierId      String?

  // Item details (can override product info or be custom)
  sku             String?
  name            String
  description     String?

  // Service details
  serviceType     FulfillmentMethod?
  serviceOptions  Json?           // For screen print colors, vinyl details, etc.

  // Pricing
  quantity        Int             @default(1)
  unitPrice       Decimal         @db.Money
  discount        Decimal         @default(0) @db.Money
  total           Decimal         @db.Money

  // Ordering
  sortOrder       Int             @default(0)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([quoteId])
  @@index([productId])
  @@index([supplierId])
}

enum LineItemType {
  PRODUCT
  SERVICE
  CUSTOM
  SETUP_FEE
  SHIPPING
  DISCOUNT
}

enum DiscountType {
  FIXED
  PERCENTAGE
}

// ===========================================
// Quote Audit Trail
// ===========================================

model QuoteAuditLog {
  id            String              @id @default(cuid())
  quote         Quote               @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  quoteId       String

  // What happened
  action        QuoteAuditAction
  description   String              // Human-readable description

  // Who made the change
  actorType     QuoteAuditActorType @default(ADMIN)
  actorId       String?             // AdminUser ID if admin, null if system/customer
  actorName     String?             // Name for display (cached)
  actorEmail    String?             // Email for display (cached)

  // Change details (JSON for flexibility)
  previousValue Json?               // Previous state/values
  newValue      Json?               // New state/values
  metadata      Json?               // Additional context

  createdAt     DateTime            @default(now())

  @@index([quoteId])
  @@index([createdAt(sort: Desc)])
  @@index([action])
}

enum QuoteAuditAction {
  CREATED
  UPDATED
  STATUS_CHANGED
  SENT_TO_CUSTOMER
  APPROVED_BY_CUSTOMER
  DECLINED_BY_CUSTOMER
  LINE_ITEM_ADDED
  LINE_ITEM_UPDATED
  LINE_ITEM_REMOVED
  CUSTOMER_CHANGED
  OWNER_CHANGED
  PRICING_UPDATED
  DELETED
  // Artwork approval actions
  ARTWORK_UPLOADED
  ARTWORK_SENT_TO_CUSTOMER
  ARTWORK_APPROVED_BY_CUSTOMER
  ARTWORK_DECLINED_BY_CUSTOMER
  ARTWORK_UPDATED
}

enum QuoteAuditActorType {
  ADMIN
  CUSTOMER
  SYSTEM
}

// ===========================================
// CRM & Customers
// ===========================================

enum CustomerStatus {
  LEAD
  PROSPECT
  ACTIVE
  INACTIVE
  CHURNED
}

enum CustomerType {
  INDIVIDUAL
  BUSINESS
  NONPROFIT
  GOVERNMENT
  EDUCATION
}

model Customer {
  id              String         @id @default(cuid())

  // Company Information
  companyName     String?
  customerType    CustomerType   @default(BUSINESS)
  website         String?
  industry        String?
  employeeCount   String?
  annualRevenue   String?

  // Primary Contact
  contactName     String
  contactTitle    String?
  email           String         @unique
  phone           String?
  mobilePhone     String?

  // Address
  addressLine1    String?
  addressLine2    String?
  city            String?
  state           String?
  postalCode      String?
  country         String?        @default("USA")

  // Shipping Address (if different)
  shippingAddressLine1  String?
  shippingAddressLine2  String?
  shippingCity          String?
  shippingState         String?
  shippingPostalCode    String?
  shippingCountry       String?

  // CRM Fields
  status          CustomerStatus @default(LEAD)
  source          String?        // How they found us (referral, web, trade show, etc.)
  assignedTo      String?        // Sales rep or account manager
  tags            String[]       // Custom tags for segmentation

  // Financial
  taxExempt       Boolean        @default(false)
  taxId           String?        // EIN or tax exempt number
  paymentTerms    String?        // Net 30, Net 60, etc.
  creditLimit     Decimal?       @db.Money

  // Communication Preferences
  preferredContact String?       // email, phone, text
  marketingOptIn   Boolean       @default(true)

  // Notes & History
  notes           String?        // General notes about the customer

  // Relations
  quotes          Quote[]

  // Timestamps
  lastContactAt   DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([email])
  @@index([companyName])
  @@index([status])
  @@index([customerType])
  @@index([createdAt(sort: Desc)])
}

// ===========================================
// Admin & Authentication
// ===========================================

model AdminUser {
  id           String         @id @default(cuid())
  email        String         @unique
  passwordHash String
  name         String
  role         AdminRole      @default(ADMIN)
  isActive     Boolean        @default(true)

  // Email verification
  emailVerified    Boolean    @default(false)
  verificationToken String?   @unique
  verificationTokenExpiry DateTime?

  // Password reset
  passwordResetToken String?   @unique
  passwordResetTokenExpiry DateTime?

  lastLoginAt  DateTime?
  sessions     AdminSession[]
  auditLogs    AuditLog[]
  ownedQuotes  Quote[]        @relation("QuoteOwner")
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([email])
  @@index([role])
  @@index([verificationToken])
  @@index([passwordResetToken])
}

model AdminSession {
  id        String    @id @default(cuid())
  token     String    @unique
  user      AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model AuditLog {
  id        String    @id @default(cuid())
  user      AdminUser @relation(fields: [userId], references: [id])
  userId    String
  action    String
  entity    String
  entityId  String?
  details   Json?
  ipAddress String?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt(sort: Desc)])
}

model PageView {
  id          String   @id @default(cuid())
  path        String
  referrer    String?
  userAgent   String?
  ipAddress   String?
  sessionId   String?
  // Enhanced tracking
  duration    Int?     // Time spent on page in seconds
  scrollDepth Int?     // Max scroll depth percentage (0-100)
  exitPage    Boolean  @default(false)
  isAdmin     Boolean  @default(false) // true for admin panel views, false for public site
  // Geographic data (populated from IP)
  country     String?
  region      String?
  city        String?
  // Device info (parsed from user agent)
  deviceType  String?  // desktop, mobile, tablet
  browser     String?
  os          String?
  createdAt   DateTime @default(now())

  @@index([path])
  @@index([createdAt(sort: Desc)])
  @@index([sessionId])
  @@index([country])
  @@index([deviceType])
  @@index([isAdmin])
}

// ===========================================
// Analytics: Session Tracking
// ===========================================

model AnalyticsSession {
  id              String    @id @default(cuid())
  sessionId       String    @unique
  // First touch attribution
  firstPage       String
  landingPage     String
  referrer        String?
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  // Session metrics
  pageCount       Int       @default(1)
  totalDuration   Int       @default(0)  // Total time in seconds
  // Geographic data
  country         String?
  region          String?
  city            String?
  // Device info
  deviceType      String?
  browser         String?
  os              String?
  ipAddress       String?
  // Timestamps
  startedAt       DateTime  @default(now())
  lastActiveAt    DateTime  @default(now())
  endedAt         DateTime?
  // Conversion tracking
  convertedToQuote Boolean  @default(false)
  quoteId          String?

  @@index([sessionId])
  @@index([startedAt(sort: Desc)])
  @@index([country])
  @@index([deviceType])
  @@index([convertedToQuote])
  @@index([utmSource])
}

// ===========================================
// Analytics: Product Views
// ===========================================

model ProductView {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  sessionId   String?
  ipAddress   String?
  referrer    String?
  duration    Int?     // Time spent viewing in seconds
  addedToQuote Boolean @default(false)
  createdAt   DateTime @default(now())

  @@index([productId])
  @@index([sessionId])
  @@index([createdAt(sort: Desc)])
}

// ===========================================
// Analytics: Quote Funnel Events
// ===========================================

enum QuoteFunnelStage {
  VIEWED_PRODUCTS
  STARTED_QUOTE
  ADDED_ITEMS
  SUBMITTED_INFO
  QUOTE_SENT
  QUOTE_APPROVED
  QUOTE_REJECTED
}

model QuoteFunnelEvent {
  id          String           @id @default(cuid())
  stage       QuoteFunnelStage
  sessionId   String?
  quoteId     String?
  customerId  String?
  // Metadata
  productIds  String[]
  metadata    Json?
  // Timestamps
  createdAt   DateTime         @default(now())

  @@index([stage])
  @@index([sessionId])
  @@index([quoteId])
  @@index([createdAt(sort: Desc)])
}

// ===========================================
// Analytics: Daily Aggregates (for fast queries)
// ===========================================

model DailyAnalytics {
  id              String   @id @default(cuid())
  date            DateTime @db.Date
  // Traffic metrics
  pageViews       Int      @default(0)
  uniqueVisitors  Int      @default(0)
  newVisitors     Int      @default(0)
  returningVisitors Int    @default(0)
  // Engagement metrics
  avgSessionDuration Int   @default(0)  // In seconds
  avgPageViews    Decimal  @default(0)
  bounceRate      Decimal  @default(0)  // Percentage
  // Conversion metrics
  quotesStarted   Int      @default(0)
  quotesSubmitted Int      @default(0)
  quotesApproved  Int      @default(0)
  conversionRate  Decimal  @default(0)
  // Product metrics
  productViews    Int      @default(0)
  topProducts     Json?    // Array of {productId, views}
  // Geographic breakdown
  topCountries    Json?    // Array of {country, count}
  // Device breakdown
  desktopVisits   Int      @default(0)
  mobileVisits    Int      @default(0)
  tabletVisits    Int      @default(0)
  // Revenue (if quotes approved)
  quotesValue     Decimal  @default(0) @db.Money

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([date])
  @@index([date(sort: Desc)])
}

// ===========================================
// Analytics: Entity Activity Tracking
// ===========================================

enum EntityType {
  PRODUCT
  VENDOR
  QUOTE
  CUSTOMER
  CATEGORY
  USER
}

enum ActivityType {
  CREATED
  UPDATED
  DELETED
  VIEWED
  PUBLISHED
  UNPUBLISHED
  STATUS_CHANGED
}

model EntityActivity {
  id          String       @id @default(cuid())
  entityType  EntityType
  entityId    String
  activityType ActivityType
  // Actor info
  userId      String?
  sessionId   String?
  ipAddress   String?
  // Change details
  oldValue    Json?
  newValue    Json?
  metadata    Json?
  createdAt   DateTime     @default(now())

  @@index([entityType])
  @@index([entityId])
  @@index([activityType])
  @@index([createdAt(sort: Desc)])
  @@index([userId])
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  EDITOR
}

// ===========================================
// Notifications & Email Settings
// ===========================================

enum NotificationChannel {
  EMAIL
  SMS
}

enum NotificationType {
  // Internal notifications
  INTERNAL_QUOTE_CREATED
  INTERNAL_QUOTE_STATUS_CHANGE
  INTERNAL_USER_VERIFICATION
  INTERNAL_ARTWORK_RESPONSE      // Notify admin when customer responds to artwork
  // External (customer) notifications
  CUSTOMER_QUOTE_SENT
  CUSTOMER_QUOTE_STATUS_CHANGE
  CUSTOMER_ARTWORK_APPROVAL      // Send artwork for customer approval
}

model NotificationSetting {
  id              String              @id @default(cuid())
  type            NotificationType    @unique
  name            String
  description     String?
  channel         NotificationChannel @default(EMAIL)
  enabled         Boolean             @default(false)

  // Email template settings
  subject         String?
  bodyTemplate    String?             // HTML template with placeholders

  // Recipients for internal notifications
  recipientEmails String[]            // For internal notifications

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([type])
  @@index([enabled])
}

model EmailConfig {
  id              Int      @id @default(1)
  provider        String   @default("gmail")  // gmail, smtp, sendgrid, etc.

  // Gmail API settings
  gmailClientId       String?
  gmailClientSecret   String?
  gmailRefreshToken   String?
  gmailAccessToken    String?
  gmailTokenExpiry    DateTime?

  // Sender settings
  fromName        String   @default("Logoz Custom")
  fromEmail       String?
  replyToEmail    String?

  // Status
  isConfigured    Boolean  @default(false)
  lastTestedAt    DateTime?
  lastTestStatus  String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model SmsConfig {
  id              Int      @id @default(1)
  provider        String   @default("twilio")  // twilio, etc.

  // Twilio settings (for future use)
  accountSid      String?
  authToken       String?
  fromNumber      String?

  // Status
  isConfigured    Boolean  @default(false)
  lastTestedAt    DateTime?
  lastTestStatus  String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model NotificationLog {
  id              String              @id @default(cuid())
  type            NotificationType
  channel         NotificationChannel

  // Recipient info
  recipientEmail  String?
  recipientPhone  String?
  recipientName   String?

  // Content
  subject         String?
  body            String?

  // Status
  status          String              @default("pending")  // pending, sent, failed
  errorMessage    String?
  sentAt          DateTime?

  // Related entities
  quoteId         String?
  customerId      String?
  userId          String?

  createdAt       DateTime            @default(now())

  @@index([type])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([quoteId])
  @@index([customerId])
}
